# MACC × Gemini CLI : Implementation Plan

**Goal:** Integrate **Gemini CLI** into **MACC** so that Gemini CLI is **fully configurable and usable** through MACC’s canonical configuration, with safe project-level generation and optional user-level merges (backups + consent).

This plan assumes MACC’s architecture described in `macc.md` (canonical “source of truth” + per-tool adapters + worktrees). It uses Gemini CLI capabilities from `GeminiCLI.md`, including:
- `settings.json` configuration layers (workspace/user/system/extension),
- hierarchical context files (`GEMINI.md`),
- custom commands (`.toml`),
- (experimental) Agent Skills (`SKILL.md`),
- extensions (`gemini-extension.json`),
- hooks system,
- sandboxing, approval modes, tool allow/deny, policy files,
- trusted folders and environment-variable redaction.

---

## 0) Scope and Terminology

### In-scope (v1)
- Generate **workspace (project) configuration** for Gemini CLI:
  - `.gemini/settings.json`
  - root `GEMINI.md` (+ optional subdir `GEMINI.md` files)
  - `.gemini/commands/*.toml` (custom commands)
  - `.gemini/skills/**/SKILL.md` (Agent Skills, optional/experimental)
  - `.geminiignore` for file discovery hygiene
  - `.gemini/sandbox.Dockerfile` (optional)
  - `.gemini/hooks/*` + hook config (optional, security-conscious)
- Provide **MACC commands** to:
  - detect/install Gemini CLI,
  - apply workspace config,
  - optionally merge user-level config (`~/.gemini/*`) with backups + consent,
  - run Gemini CLI inside worktrees (interactive + headless).
- Provide a consistent mapping from MACC’s canonical config to Gemini CLI settings, commands, and skills.

### Out-of-scope (v1)
- Re-implementing Gemini CLI.
- Managing/committing secrets (API keys, OAuth tokens).
- Guaranteeing identical behavior across all Gemini CLI versions (we will pin/record a compatible version range and add a “doctor” check).

---

## 1) Gemini CLI Integration Strategy (High-Level)

### 1.1 Adapter responsibilities

1. Read canonical config (`.macc/macc.yaml`) + presets.
2. Resolve tool selection for Gemini CLI (standards, skills, agents, MCP servers, permissions policy).
3. Generate workspace files under `.gemini/` and `GEMINI.md`.
4. Optionally apply user-level changes to `~/.gemini/` (backup + consent).
5. Provide validation + “doctor” diagnostics:
   - detect if Gemini CLI installed and usable,
   - detect trusted-folder state and project trust status,
   - warn if project is untrusted (workspace settings ignored),
   - verify settings JSON schema plausibility (best-effort),
   - verify required files exist for selected features.

### 1.2 Workspace-first, Extension-second
- **Default**: use workspace-level files (`.gemini/*`, `GEMINI.md`) committed in the repo, so every contributor gets consistent behavior.
- **Optional**: provide a **MACC-managed Gemini extension** for user-level “plugins” (MCP servers, extra commands/skills) that should be global and not committed.

Gemini CLI supports extensions under `~/.gemini/extensions/<name>/gemini-extension.json` and can bundle MCP servers, exclude tools, custom commands, and skills. MACC can leverage this for user-level plugins.

---

## 2) Required Generated Files and Layout

### 2.1 Workspace (project) files generated by MACC

Recommended baseline layout:

```
<repo>/
  GEMINI.md
  .gemini/
    settings.json
    commands/
      validate.toml
      implement.toml
      next-task.toml
      refresh-context.toml
      update-progress.toml
      git-add-commit-push.toml
      validate-update-push.toml
      # ...optional extras
    skills/                     # optional (experimental)
      code-reviewer/
        SKILL.md
      security-check/
        SKILL.md
      seo-check/
        SKILL.md
      # ...
    hooks/                      # optional
      shell-guard.sh
      lint-on-write.sh
    sandbox.Dockerfile          # optional
  .geminiignore
  .gitignore (updated)
  memory-bank/                  # if used by your MACC workflow
```

### 2.2 User-level files (optional merges; never committed)
Gemini CLI uses user-level locations like:
- `~/.gemini/settings.json`
- `~/.gemini/skills/`
- `~/.gemini/extensions/`
- `~/.gemini/policies/`
- `~/.gemini/trustedFolders.json` (managed by Gemini CLI)

MACC should **never** write secrets, but it can install safe defaults and templates.

---

## 3) Canonical MACC → Gemini CLI Mapping

### 3.1 Mapping table (core)
| MACC concept | Gemini CLI feature | Where | Notes |
|---|---|---|---|
| “Standards” | `GEMINI.md` + optional `.gemini/styleguide.md` imported by `GEMINI.md` | workspace | Gemini’s hierarchical context system is designed for this. |
| “Skills” (workflows like `/validate`) | Custom commands (`.gemini/commands/*.toml`) **and/or** Agent Skills (`.gemini/skills/**/SKILL.md`) | workspace | Custom commands are explicit; Agent Skills are on-demand (experimental). |
| “Agents” (roles like `code-reviewer`) | Agent Skills (best fit) | workspace/user/extension | Requires `experimental.skills=true`. |
| MCP servers | `mcpServers` in `.gemini/settings.json` or in an extension | workspace or user | Prefer workspace when team-shared; extension for per-user plugins. |
| Permissions / allow/deny | `tools.*`, `excludeTools`, `security.*`, policy files | workspace + user | Use workspace for safe defaults; use user policies for stricter local rules. |
| Worktrees | Run Gemini CLI in each worktree directory + generate per-worktree `.gemini/` and `GEMINI.md` | worktree | Trust behavior depends on the folder trust feature. |

### 3.2 Configuration precedence awareness
Gemini CLI merges config from multiple layers (high → low):
1) workspace `.gemini/settings.json`
2) user `~/.gemini/settings.json`
4) extensions

MACC should treat **workspace files** as the primary artifact for repo reproducibility.

---

## 4) Workspace Configuration Details

### 4.1 `.gemini/settings.json` generation

MACC should generate a `settings.json` that covers:
- language + model defaults,
- tool approval mode and allow/deny,
- sandbox configuration defaults,
- context discovery + ignoring,
- MCP servers (if selected),
- privacy defaults,
- security defaults (folder trust and env redaction recommendations),
- experimental toggles (skills, plan mode, etc),
- hooks config (optional).

**Suggested baseline template (safe defaults):**
```json
{
  "language": "en",
  "privacy": {
    "usageStatisticsEnabled": false
  },
  "context": {
    "fileName": "GEMINI.md",
    "discoveryMaxDirs": 200,
    "fileFiltering": {
      "respectGitIgnore": true,
      "respectGeminiIgnore": true
    }
  },
  "tools": {
    "approvalMode": "default",
    "enableToolOutputTruncation": true,
    "truncateToolOutputThreshold": 4000000,
    "truncateToolOutputLines": 1000,
    "disableLLMCorrection": true,
    "useRipgrep": true,
    "core": {
      "exclude": []
    },
    "autoAccept": []
  },
  "security": {
    "disableYoloMode": false,
    "enablePermanentToolApproval": false,
    "folderTrust": {
      "enabled": false
    },
    "environmentVariableRedaction": {
      "enabled": true,
      "allowed": []
    }
  },
  "experimental": {
    "skills": false,
    "plan": false
  }
}
```

**Rendering rules**
- Keep `privacy.usageStatisticsEnabled` configurable in MACC.
- Keep `context.discoveryMaxDirs` configurable (useful for large repos).
- Always set `respectGitIgnore` and `respectGeminiIgnore` to avoid pulling noise.
- Keep YOLO disabled by default in workspace; allow enabling only via explicit MACC selection/consent.
- Keep `tools.core.exclude` and `tools.autoAccept` derived from MACC “permissions allow/deny” policies.
- If the user selects “Agent Skills” in MACC, set `experimental.skills=true` and generate `.gemini/skills/*`.

### 4.2 `GEMINI.md` (root) generation

Gemini CLI loads hierarchical “memory” context files and concatenates them; root `GEMINI.md` should be the single, versioned entry point.

**Recommended content structure**
1) Project overview + goals
2) Coding standards (rendered from MACC standards presets)
3) Repo navigation hints (“key directories”)
4) Required workflows (“always run tests”)
5) Security + secrets policy
6) How to use MACC-provided commands/skills
7) Worktree workflow guidance

**Example snippet**
```md
# Project Instructions (MACC)

## Language
- Use English for code, docs, and commit messages.

## Package manager
- Use pnpm only.

## Workflow
- Prefer small PR-sized changes.
- Update progress notes in `progress.md` when asked.
- When asked to validate: run `pnpm lint`, `pnpm build`, then `pnpm test:e2e`.

## MACC Commands
- Use `/validate` to run the standard validation pipeline.
- Use `/implement` for full implementation workflow.
```

**Optional modularization**
Gemini supports importing Markdown via `@path/to/file.md` in context files. MACC can optionally render:
- `memory-bank/standards.md`
- `memory-bank/workflows.md`
and then include them from `GEMINI.md`.

### 4.3 `.geminiignore` generation
MACC should generate a conservative `.geminiignore` to prevent noisy context discovery and accidental exposure of sensitive files.

Suggested baseline:
```
# dependencies / builds
node_modules/
dist/
build/
.next/
.out/

# VCS
.git/
.worktrees/

# secrets
.env
.env.*
*.pem
*.key

# MACC internal backups
.macc/backups/
```

### 4.4 Custom Commands (`.gemini/commands/*.toml`)
Gemini CLI supports custom commands defined as TOML files in:
- workspace: `.gemini/commands/`
- user: `~/.gemini/commands/`
- extensions: `<ext>/commands/`

**MACC mapping**
- Each MACC “skill” becomes at least one `.toml` command.
- Names should match the MACC command name without the leading slash.

**Example: `.gemini/commands/validate.toml`**
```toml
description = "Run the standard validation pipeline (lint → build → e2e tests)."
prompt = \"\"\"
You are executing the project's validation workflow.

1) Run:
- pnpm lint
- pnpm build
- pnpm test:e2e

2) Summarize failures clearly and propose fixes.
3) If all succeeds, report success and next steps.
\"\"\"
```

**Example: `.gemini/commands/implement.toml`**
```toml
description = "End-to-end implementation workflow: read context, plan, implement, validate, review."
prompt = \"\"\"
Follow this workflow:
1) Read relevant docs and files (GEMINI.md, memory-bank, existing code).
2) Propose a short implementation plan.
3) Implement small, safe changes.
4) Validate via /validate (or equivalent commands).
5) Provide a short review summary and suggested commit message.
\"\"\"
```

### 4.5 Agent Skills (`.gemini/skills/**/SKILL.md`) — optional/experimental
Gemini’s Agent Skills are enabled via `experimental.skills=true` and discovered in:
- `.gemini/skills/` (workspace)
- `~/.gemini/skills/` (user)
- extension skills

**MACC mapping**
- MACC “agents” map naturally to Agent Skills (e.g., `code-reviewer`, `seo-specialist`).
- Some “skills” can also be Agent Skills, especially those that should trigger automatically (“security-check”, “db-check”).

**Example: `.gemini/skills/code-reviewer/SKILL.md`**
```md
---
name: code-reviewer
description: Expertise in reviewing code for style, security, and performance. Use when asked to review changes or give feedback.
---

# Code Reviewer

1) Review the diff or relevant files.
2) Verify conventions from GEMINI.md.
3) Identify security risks and performance issues.
4) Suggest tests and edge cases.
5) Provide actionable, prioritized feedback.
```

### 4.6 MCP Servers in settings
Gemini CLI supports MCP servers in `settings.json` and in extensions.

**MACC approach**
- Provide MCP server templates in MACC canonical config.
- Render to `.gemini/settings.json` under `mcpServers` **without secrets**.
- Provide a `.gemini/.env.example` for secrets and ensure `.gemini/.env` is gitignored.

Example snippet:
```json
{
  "mcpServers": {
    "brave-search": {
      "command": "node",
      "args": ["path/to/brave-mcp.js"],
      "env": {
        "BRAVE_API_KEY": "${BRAVE_API_KEY}"
      }
    }
  }
}
```

---

## 5) User-Level Integration (Backups + Consent)

MACC must follow the “backup + consent” rule before touching any `~/.gemini/*` files.

### 5.1 Optional user-level merges to support
1) `~/.gemini/settings.json`
   - Enable **trusted folders** (`security.folderTrust.enabled=true`) if user wants it.
   - Enable **environment variable redaction**.
   - Configure global UI settings (theme, editor, vim-mode).
2) `~/.gemini/policies/*.toml`
   - Install “MACC baseline security policies” (deny dangerous shell patterns, etc).
3) `~/.gemini/extensions/<macc-plugin>/`
   - Install or link a MACC-managed extension that provides global “plugins” (optional).

### 5.2 Backup format
On every change:
- copy affected file(s) to `~/.gemini/.macc-backups/<timestamp>/...`
- show a summary diff (or a rendered JSON diff)
- require explicit consent in TUI or `--yes` flag.

---

## 6) Permissions, Safety, and Security Defaults

### 6.1 Tool approval strategy
Gemini CLI supports approval modes and tool allow/deny via settings. MACC should:
- default to **safe approval** (`tools.approvalMode="default"`)
- provide a curated list of **auto-accepted** commands for common safe workflows (opt-in)
- block obviously dangerous commands by default

**Workspace allowlist / denylist strategy**
- Use `tools.core.exclude` (and `excludeTools` in extensions) for hard blocks.
- Use user-level policies for strict local hardening.

### 6.2 Trusted Folders impact (critical)
If the user enables folder trust at user-level, an **untrusted** workspace causes Gemini CLI to ignore:
- workspace `.gemini/settings.json`
- workspace `.env`
- custom commands
- MCP server connections
- auto-acceptance

**MACC must detect and warn**:
- In `macc doctor` and `macc worktree doctor`, read `~/.gemini/trustedFolders.json` and inform whether the current project/worktree folder is trusted.
- Provide remediation instructions:
  - run `gemini` in the folder and choose **Trust folder**,
  - or use `/permissions` inside Gemini CLI.

### 6.3 Environment variable redaction
Since hooks and scripts can run with user privileges, MACC should recommend enabling:
```json
{
  "security": {
    "environmentVariableRedaction": {
      "enabled": true,
      "allowed": ["MY_REQUIRED_TOOL_KEY"]
    }
  }
}
```
and keep it configurable.

### 6.4 Sandboxing (optional but recommended)
Gemini CLI sandbox can be enabled via `--sandbox` / `GEMINI_SANDBOX`, and can use a project-specific `.gemini/sandbox.Dockerfile`.

MACC should:
- optionally generate `.gemini/sandbox.Dockerfile` based on selected stacks (Node, Python, etc)
- optionally provide `macc worktree run --sandbox` which runs `gemini -s`
- ensure documentation for `BUILD_SANDBOX=1` usage.

---

## 7) Hooks (Optional Advanced Integration)

Gemini CLI supports hooks configured in `settings.json` and executed as commands.

### 7.1 Why use hooks in MACC
Hooks can enforce workflows:
- run a lightweight security check before file writes,
- auto-run lint after edits,
- block dangerous operations.

### 7.2 Minimal recommended hook set (opt-in)
- `BeforeTool` on `run_shell_command`:
  - deny `rm -rf` / `curl|sh` unless explicitly permitted
- `AfterTool` on edit/write tools:
  - run `pnpm lint` (fast lint) for TypeScript projects

### 7.3 Implementation notes
- Store scripts under `.gemini/hooks/`
- Configure hooks in `.gemini/settings.json` under `hooks`
- Ensure scripts print only JSON to stdout and log to stderr

Example config:
```json
{
  "hooks": {
    "BeforeTool": [
      {
        "matcher": "run_shell_command",
        "hooks": [
          {
            "name": "macc-shell-guard",
            "type": "command",
            "command": "$GEMINI_PROJECT_DIR/.gemini/hooks/shell-guard.sh",
            "timeout": 5000
          }
        ]
      }
    ]
  }
}
```

**Security warning:** project-level hooks are powerful; treat them as trusted code only. MACC should keep hooks disabled by default and require explicit enablement in canonical config.

---

## 8) MACC Command Surface for Gemini CLI

### 8.1 Detection & install
Add:
- `macc tool detect gemini`
- `macc tool install gemini`

Use documented install methods (primary: npm global; fallback: npx). Record installed version in `macc doctor`.

### 8.2 Apply pipeline
`macc apply --tools gemini` should:
1) Render workspace files listed in Section 2.1
2) Update `.gitignore` if needed (ensure `.gemini/.env` and secrets are ignored)
3) Write atomically (tmp + replace)
4) Produce a summary of written files

### 8.3 Doctor checks
`macc doctor` / `macc worktree doctor` should check:
- `gemini` executable in PATH
- `gemini --version`
- presence of workspace `.gemini/settings.json` and root `GEMINI.md`
- if folder trust enabled: is current folder trusted?
- optional: warn if `experimental.skills=true` but no `.gemini/skills/` exists
- optional: warn if MCP servers configured but binaries are missing

### 8.4 Worktree commands
- `macc worktree run <id>` should launch Gemini CLI in that worktree directory.
- Provide flags mapping:
  - `--headless`: use `gemini -p "<prompt>"` for automation
  - `--sandbox`: add `-s`
  - `--approval-mode=...` derived from MACC config (or explicit CLI override)

---

## 9) Automation “Ralph” Compatibility

### 9.1 Headless execution patterns
Gemini CLI supports non-interactive prompts (e.g., `gemini -p "..."`). MACC’s `scripts/ralph.sh` can:
- run `gemini -p "@{memory-bank/next-task.md}"` style prompts
- set `--approval-mode` and `--allowed-tools` carefully

### 9.2 Recommended approach
- Keep Ralph in **safe approval mode** unless explicitly opted into YOLO.
- Use custom commands to standardize automation prompts.
- Add `--fake-responses` in tests for deterministic CI validation (Gemini CLI supports fake/recorded responses for testing).

### 9.3 TUI configuration view (Gemini)
- Dedicated Gemini screen in the TUI for **config modification** (Rust + Ratatui).
- Fields: model preset, sandbox/approval defaults, `user_mcp_merge` opt-in toggle.
- Skills: multi-select from catalog **and remote Git/HTTP sources** (Fetch Unit + Selection; download once, install selected subpaths).
- MCP: select from catalog or remote Git/HTTP; render to `.gemini/settings.json` `mcpServers` with placeholders only; flag optional user merge (consent).
- Toggles for optional artifacts: `.gemini/commands/*.toml`, `.gemini/styleguide.md`, `.gemini/hooks/*`, `.gemini/sandbox.Dockerfile`.
- Preview shows planned writes, scopes (project vs user), backups, and consent requirements.

### 9.4 Detailed Gemini TUI fields & behaviors
- **Enable toggle**: turn Gemini tool on/off; disable navigation when off.
- **Model & sandbox**: model preset input; approval/sandbox mode selector; `user_mcp_merge` checkbox (default off, consent-gated when on).
- **Skills panel**: table {id, source (catalog/git/http), subpath}; add-remote flow parses URL + optional subpath into Fetch Unit; cache key excludes subpath to reuse downloads; multi-select installs only chosen subpaths into `.gemini/skills/`.
- **Commands/styleguide/hooks toggles**: checkboxes to include `.gemini/commands/*.toml`, `.gemini/styleguide.md`, `.gemini/hooks/*`, `.gemini/sandbox.Dockerfile`.
- **MCP panel**: catalog + “Add remote” (git/http) with subpath; renders to `.gemini/settings.json` `mcpServers` with env placeholders only; optional user-merge flag displayed and consent-required if enabled.
- **Preview pane**: deterministic plan output; highlights project vs user scope; indicates backups/consent before apply; refresh action available.

---

## 10) Testing Plan

### 10.1 Unit tests (adapter)
- Golden file tests: given a canonical `.macc/macc.yaml`, the adapter produces stable:
  - `.gemini/settings.json`
  - `GEMINI.md`
  - `.gemini/commands/*.toml`
  - `.geminiignore`
- Validate JSON formatting and deterministic key ordering.

### 10.2 Integration tests
- Use Gemini CLI testing flags (`--fake-responses`, `--record-responses`) to validate that:
  - Gemini CLI starts in a temporary workspace with generated config
  - custom commands are discovered
  - context files are loaded (inspect via `/memory show` in interactive testing, or equivalent logs)

### 10.3 Safety tests
- Ensure secrets are never written:
  - static scan on generated output to verify no real env values were inlined
- Ensure `.gitignore` contains required entries for `.gemini/.env` and similar

---

## 11) Milestones and Deliverables

### Milestone A — MVP: Workspace config + run (Gemini CLI usable via MACC)
- [ ] Add `gemini_cli` tool to MACC tool registry
- [ ] Implement adapter rendering:
  - [ ] `.gemini/settings.json`
  - [ ] `GEMINI.md`
  - [ ] `.geminiignore`
  - [ ] `.gemini/commands/*.toml` for at least `/validate` and `/implement`
- [ ] Implement `macc worktree run` integration for Gemini CLI
- [ ] Implement `macc doctor` checks (install/version + file presence)
- [ ] Document usage in `README.md`

### Milestone B — Skills + MCP + permissions
- [ ] Render Agent Skills (opt-in, `experimental.skills=true`)
- [ ] Render MCP server templates into `.gemini/settings.json` (no secrets)
- [ ] Render permissions into:
  - `tools.core.exclude`
  - `tools.autoAccept`
  - `tools.approvalMode`
- [ ] Add user-level policy templates (installed with consent)

### Milestone C — Hooks + sandbox + user-level merges
- [ ] Hook templates (opt-in) + `.gemini/hooks/*`
- [ ] Sandbox Dockerfile template generation (opt-in)
- [ ] User-level merge pipeline with backups + consent:
  - `~/.gemini/settings.json`
  - `~/.gemini/policies/*`
- [ ] Optional MACC extension generator/installer (plugin system)

---

## 12) Acceptance Criteria

- ✅ After `macc apply --tools gemini`, the project contains:
  - `GEMINI.md`
  - `.gemini/settings.json`
  - `.gemini/commands/validate.toml`
  - `.gemini/commands/implement.toml`
  - `.geminiignore`
- ✅ Running `gemini` in the repo uses the configured context and discovers custom commands.
- ✅ No secrets are written to the repo (only placeholders/templates).
- ✅ `macc doctor` reports:
  - whether Gemini CLI is installed,
  - whether the workspace is trusted (if folder trust enabled),
  - whether generated files are present and consistent.
- ✅ Worktrees created by MACC can run Gemini CLI with their own generated config.

---

## Appendix A — Recommended Default Commands to Ship in v1

- `/validate`
- `/implement`
- `/next-task`
- `/refresh-context`
- `/update-progress`
- `/git-add-commit-push`
- `/validate-update-push`
- `/permissions-allow` (documentation-only or command that describes how to set safe approvals)

---

## Appendix B — Compatibility Notes

- Agent Skills are **experimental** and must be enabled.
- Trusted folders, if enabled, can cause workspace config to be ignored until the folder is trusted.
- Hooks are powerful and should be opt-in; enabling environment-variable redaction is strongly recommended.
